<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Instagram Connect Console</title>
    <script>
      window.tailwind = window.tailwind || {};
      window.tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#fff4f1',
                100: '#ffe7e1',
                200: '#ffcdc4',
                300: '#ffac9b',
                400: '#ff8269',
                500: '#ff5b40',
                600: '#f74e32',
                700: '#dd3619',
                800: '#b02b14',
                900: '#81230f',
              },
            },
            fontFamily: {
              display: ['"Plus Jakarta Sans"', 'ui-sans-serif', 'system-ui'],
              body: ['"Inter"', 'ui-sans-serif', 'system-ui'],
            },
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@600;700&display=swap"
    />
    <style>
      :root {
        color-scheme: light;
      }
      body {
        font-family: 'Inter', ui-sans-serif, system-ui;
      }
      .grid-overlay {
        background-image: radial-gradient(circle at 1px 1px, rgba(15, 23, 42, 0.12) 1px, transparent 0);
        background-size: 20px 20px;
      }
    </style>
  </head>
  <body class="relative min-h-screen bg-slate-50 text-slate-900">
    <div class="pointer-events-none absolute inset-0 overflow-hidden">
      <div class="grid-overlay absolute inset-0 opacity-40"></div>
      <div class="absolute -left-32 top-10 h-64 w-64 rounded-full bg-brand-200 blur-3xl"></div>
      <div class="absolute bottom-[-10rem] right-[-4rem] h-96 w-96 rounded-full bg-sky-200 blur-3xl"></div>
    </div>
    <main class="relative mx-auto flex max-w-6xl flex-col gap-10 px-4 pb-16 pt-12 sm:px-6 lg:px-8">
      <!-- User info bar -->
      <div class="flex items-center justify-between rounded-2xl border border-slate-200 bg-white/80 px-6 py-3 shadow-sm backdrop-blur">
        <div class="flex items-center gap-3">
          <div class="flex h-8 w-8 items-center justify-center rounded-full bg-brand-500 text-sm font-semibold text-white">
            <span id="user-initial">U</span>
          </div>
          <div>
            <p class="text-sm font-medium text-slate-900" id="user-email">Loading...</p>
            <p class="text-xs text-slate-500">Logged in</p>
          </div>
        </div>
        <form method="POST" action="/auth/logout">
          <button
            type="submit"
            class="rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 transition hover:border-slate-300 hover:text-slate-900"
          >
            Log out
          </button>
        </form>
      </div>

      <header class="mx-auto max-w-3xl text-center">
        <div class="mb-4 inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/80 px-3 py-1 text-sm font-medium text-slate-600 shadow-sm">
          <span class="inline-flex h-2 w-2 rounded-full bg-emerald-500"></span>
          Live demo environment
        </div>
        <h1 class="font-display text-4xl font-semibold tracking-tight text-slate-900 sm:text-5xl">
          Seamlessly connect Instagram and manage your webhooks
        </h1>
        <p class="mt-4 text-lg text-slate-600">
          Launch the Meta OAuth flow in a single tap, confirm the accounts you manage, and fine-tune webhook subscriptions without leaving this page.
        </p>
        <div class="mt-8 flex flex-col items-center justify-center sm:flex-row">
          <button
            id="connect-btn"
            class="inline-flex items-center justify-center rounded-full bg-slate-900 px-6 py-3 text-base font-semibold text-white shadow-lg shadow-slate-900/20 transition hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-900"
            type="button"
          >
            Connect Instagram
          </button>
        </div>
      </header>

      <section class="grid gap-6 lg:grid-cols-5">
        <div class="lg:col-span-3">
          <div class="rounded-3xl border border-slate-200 bg-white/80 p-8 shadow-xl shadow-slate-900/5 backdrop-blur">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-xl font-semibold text-slate-900">Connection overview</h2>
                <p class="mt-1 text-sm text-slate-500">Status updates the moment the OAuth flow completes.</p>
              </div>
              <span
                id="status-pill"
                class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-slate-100 px-4 py-1 text-sm font-medium text-slate-600"
              >
                Disconnected
              </span>
            </div>
            <dl class="mt-8 grid gap-4 md:grid-cols-2">
              <div class="rounded-2xl border border-slate-200 bg-white/70 p-5 shadow-sm">
                <dt class="text-sm font-medium text-slate-500">Facebook Page</dt>
                <dd class="mt-2 text-lg font-semibold text-slate-900" id="page-name">Not connected</dd>
                <p class="mt-1 text-sm text-slate-500">
                  ID:
                  <code class="rounded bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600" id="page-id">—</code>
                </p>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-white/70 p-5 shadow-sm">
                <dt class="text-sm font-medium text-slate-500">Instagram Account</dt>
                <dd class="mt-2 text-lg font-semibold text-slate-900" id="ig-handle">Not linked</dd>
                <p class="mt-1 text-sm text-slate-500">
                  ID:
                  <code class="rounded bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600" id="ig-id">—</code>
                </p>
              </div>
            </dl>
            <div id="connection-hint" class="mt-6 rounded-2xl border border-dashed border-brand-200 bg-brand-50/80 px-5 py-4 text-sm text-brand-800">
              Use the “Connect Instagram” button above to start the OAuth login and retrieve your business assets.
            </div>
          </div>
        </div>
        <div class="lg:col-span-2">
          <div class="h-full rounded-3xl border border-slate-200 bg-white/80 p-8 shadow-xl shadow-slate-900/5 backdrop-blur">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-xl font-semibold text-slate-900">Connect to real-time updates</h2>
                <p class="mt-1 text-sm text-slate-500">Choose the Instagram moments we’ll send to your app automatically.</p>
              </div>
              <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-100 px-3 py-1 text-xs font-medium uppercase tracking-wide text-slate-600">
                Real-time
              </span>
            </div>
            <div id="webhook-list" class="mt-6 space-y-3"></div>
            <p id="webhook-hint" class="mt-6 hidden rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700">
              Connect an account first to enable webhook management.
            </p>
          </div>
        </div>
      </section>

      <section class="grid gap-6 lg:grid-cols-2">
        <div class="rounded-3xl border border-slate-200 bg-white/80 p-8 shadow-lg shadow-slate-900/5 backdrop-blur">
          <h3 class="text-lg font-semibold text-slate-900">How it works</h3>
          <ol class="mt-4 space-y-4 text-sm text-slate-600">
            <li class="flex gap-3">
              <span class="mt-1 flex h-6 w-6 items-center justify-center rounded-full bg-brand-500 text-sm font-semibold text-white">1</span>
              Kick off the Meta OAuth dialog and choose the Facebook Page that owns your Instagram account.
            </li>
            <li class="flex gap-3">
              <span class="mt-1 flex h-6 w-6 items-center justify-center rounded-full bg-brand-500 text-sm font-semibold text-white">2</span>
              We store the resulting page and Instagram IDs securely on the server for this demo session.
            </li>
            <li class="flex gap-3">
              <span class="mt-1 flex h-6 w-6 items-center justify-center rounded-full bg-brand-500 text-sm font-semibold text-white">3</span>
              Subscribe to webhook fields to stream mentions, comments, and direct messages back to your app instantly.
            </li>
          </ol>
        </div>
        <div class="rounded-3xl border border-slate-200 bg-white/80 p-8 shadow-lg shadow-slate-900/5 backdrop-blur">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-900">Webhook Events</h3>
            <div class="flex gap-2">
              <select id="statusFilter" class="rounded-lg border border-slate-300 px-3 py-1.5 text-sm">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="processed">Processed</option>
                <option value="failed">Failed</option>
                <option value="dead_letter">Dead Letter</option>
              </select>
              <button id="refreshEvents" class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm font-medium hover:bg-slate-50">
                Refresh
              </button>
            </div>
          </div>

          <!-- Statistics -->
          <div id="webhookStats" class="mt-4 grid grid-cols-5 gap-3">
            <div class="rounded-lg bg-slate-100 p-3 text-center">
              <div class="text-xs text-slate-600">Total</div>
              <div class="text-lg font-semibold text-slate-900" id="stat-total">0</div>
            </div>
            <div class="rounded-lg bg-blue-100 p-3 text-center">
              <div class="text-xs text-blue-600">Pending</div>
              <div class="text-lg font-semibold text-blue-900" id="stat-pending">0</div>
            </div>
            <div class="rounded-lg bg-green-100 p-3 text-center">
              <div class="text-xs text-green-600">Processed</div>
              <div class="text-lg font-semibold text-green-900" id="stat-processed">0</div>
            </div>
            <div class="rounded-lg bg-red-100 p-3 text-center">
              <div class="text-xs text-red-600">Failed</div>
              <div class="text-lg font-semibold text-red-900" id="stat-failed">0</div>
            </div>
            <div class="rounded-lg bg-purple-100 p-3 text-center">
              <div class="text-xs text-purple-600">Dead Letter</div>
              <div class="text-lg font-semibold text-purple-900" id="stat-dead_letter">0</div>
            </div>
          </div>

          <!-- Events List -->
          <div id="webhookEvents" class="mt-4 space-y-2">
            <p class="text-sm text-slate-500 text-center py-8">No webhook events yet</p>
          </div>

          <!-- Event Detail Modal -->
          <div id="eventModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold">Event Details</h4>
                <button id="closeModal" class="text-slate-400 hover:text-slate-600">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <div id="eventDetails"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-16 border-t border-slate-200 bg-white/70 py-6 text-center text-sm text-slate-500">
      <a
        href="/privacy-policy"
        class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900"
      >
        <span>View privacy policy</span>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5H21m0 0v7.5M21 4.5l-9 9m-3-3H3m0 0v9m0-9l9 9"></path>
        </svg>
      </a>
    </footer>

    <div
      id="feedback"
      class="pointer-events-none fixed inset-x-4 bottom-6 z-50 flex justify-center opacity-0 transition-all duration-300 ease-out sm:inset-auto sm:right-6 sm:w-auto"
    >
      <div
        id="feedback-inner"
        class="pointer-events-auto flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-medium text-white shadow-xl shadow-emerald-500/30"
      >
        <span id="feedback-icon">✓</span>
        <span id="feedback-text">Connected successfully</span>
        <button
          id="feedback-dismiss"
          class="rounded-full bg-white/20 px-2 py-1 text-xs font-semibold uppercase tracking-wide text-white/80 transition hover:bg-white/30"
          type="button"
        >
          Dismiss
        </button>
      </div>
    </div>

    <script>
      const AVAILABLE_WEBHOOKS = [
        {
          id: 'messages',
          title: 'Direct messages',
          description: 'Receive DMs sent to your Instagram business inbox in real time.',
        },
        {
          id: 'comments',
          title: 'Post comments',
          description: 'Track comments on organic and promoted posts as they happen.',
        },
        {
          id: 'mentions',
          title: 'Mentions & tags',
          description: 'Get alerted when someone @mentions your handle in stories or captions.',
        },
        {
          id: 'story_insights',
          title: 'Story insights',
          description: 'Collect analytics for story interactions and retention.',
        },
      ];

      const connectBtn = document.getElementById('connect-btn');
      const statusPill = document.getElementById('status-pill');
      const pageName = document.getElementById('page-name');
      const pageId = document.getElementById('page-id');
      const igHandle = document.getElementById('ig-handle');
      const igId = document.getElementById('ig-id');
      const connectionHint = document.getElementById('connection-hint');
      const webhookList = document.getElementById('webhook-list');
      const webhookHint = document.getElementById('webhook-hint');
      const feedback = document.getElementById('feedback');
      const feedbackInner = document.getElementById('feedback-inner');
      const feedbackText = document.getElementById('feedback-text');
      const feedbackIcon = document.getElementById('feedback-icon');
      const feedbackDismiss = document.getElementById('feedback-dismiss');

      let hideFeedbackTimeout = null;
      let cachedStatus = { connected: false, webhooks: [] };

      function showFeedback(message, variant = 'success') {
        const styles = {
          success: 'bg-emerald-500 text-white shadow-emerald-500/30',
          error: 'bg-red-500 text-white shadow-red-500/30',
          info: 'bg-slate-900 text-white shadow-slate-900/20',
        };
        const iconMap = { success: '✓', error: '⚠️', info: 'ℹ️' };

        feedbackInner.className = `pointer-events-auto flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium shadow-xl transition ${
          styles[variant] || styles.success
        }`;
        feedbackIcon.textContent = iconMap[variant] || iconMap.success;
        feedbackText.textContent = message;
        feedback.classList.remove('opacity-0', 'translate-y-4');
        feedback.classList.add('opacity-100');

        clearTimeout(hideFeedbackTimeout);
        hideFeedbackTimeout = setTimeout(hideFeedback, 4000);
      }

      function hideFeedback() {
        feedback.classList.remove('opacity-100');
        feedback.classList.add('opacity-0');
      }

      feedbackDismiss.addEventListener('click', () => {
        hideFeedback();
        clearTimeout(hideFeedbackTimeout);
      });

      connectBtn.addEventListener('click', () => {
        window.location.href = '/login';
      });

      function renderWebhookItems(status) {
        webhookList.innerHTML = '';
        const activeFields = new Set(status.webhooks || []);

        AVAILABLE_WEBHOOKS.forEach((hook) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'rounded-2xl border border-slate-200 bg-white/90 p-5 shadow-sm transition';

          const topRow = document.createElement('div');
          topRow.className = 'flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between';

          const toggleButton = document.createElement('button');
          toggleButton.type = 'button';
          toggleButton.className = 'flex w-full items-center justify-between gap-2 text-left text-base font-semibold text-slate-900 transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500';
          toggleButton.setAttribute('aria-expanded', 'false');

          const title = document.createElement('span');
          title.className = 'text-left';
          title.textContent = hook.title;

          const chevron = document.createElement('span');
          chevron.className = 'text-sm text-slate-400 transition-transform duration-200';
          chevron.textContent = '▾';

          toggleButton.appendChild(title);
          toggleButton.appendChild(chevron);

          const actionButton = document.createElement('button');
          actionButton.type = 'button';
          actionButton.dataset.field = hook.id;
          actionButton.className = 'inline-flex items-center justify-center rounded-full border px-5 py-2 text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2';

          const description = document.createElement('p');
          description.className = 'mt-2 hidden text-sm text-slate-500';
          description.textContent = hook.description;

          const isActive = activeFields.has(hook.id);

          if (isActive) {
            actionButton.textContent = 'Subscribed';
            actionButton.classList.add('border-transparent', 'bg-brand-600', 'text-white', 'hover:bg-brand-700', 'focus-visible:outline-brand-600');
          } else {
            actionButton.textContent = 'Subscribe';
            actionButton.classList.add('border-slate-200', 'bg-white', 'text-slate-700', 'hover:border-slate-300', 'hover:text-slate-900', 'focus-visible:outline-slate-900');
          }

          actionButton.addEventListener('click', () => {
            if (!cachedStatus.connected) {
              showFeedback('Connect your account first to manage webhooks.', 'info');
              return;
            }
            actionButton.disabled = true;
            actionButton.classList.add('opacity-60');
            const action = isActive ? unsubscribeWebhook(hook.id) : subscribeWebhook(hook.id);
            action
              .catch((err) => {
                console.error(err);
                showFeedback(err.message || 'Unable to update webhook.', 'error');
              })
              .finally(() => {
                actionButton.disabled = false;
                actionButton.classList.remove('opacity-60');
              });
          });

          let expanded = false;
          const setExpanded = (value) => {
            expanded = value;
            toggleButton.setAttribute('aria-expanded', String(expanded));
            chevron.textContent = expanded ? '▴' : '▾';
            description.classList.toggle('hidden', !expanded);
          };

          toggleButton.addEventListener('click', () => {
            setExpanded(!expanded);
          });

          setExpanded(false);

          topRow.appendChild(toggleButton);
          topRow.appendChild(actionButton);
          wrapper.appendChild(topRow);
          wrapper.appendChild(description);
          webhookList.appendChild(wrapper);
        });
      }

      async function subscribeWebhook(field) {
        const response = await fetch('/api/webhooks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ field }),
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Failed to subscribe.');
        }

        showFeedback(`Subscribed to ${field} updates.`, 'success');
        await refreshStatus();
      }

      async function unsubscribeWebhook(field) {
        const response = await fetch(`/api/webhooks/${encodeURIComponent(field)}`, {
          method: 'DELETE',
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Failed to unsubscribe.');
        }

        showFeedback(`Unsubscribed from ${field} updates.`, 'info');
        await refreshStatus();
      }

      function updateConnectionSection(status) {
        cachedStatus = status;
        const connected = Boolean(status.connected);

        if (connected) {
          statusPill.textContent = 'Connected';
          statusPill.className = 'inline-flex items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 px-4 py-1 text-sm font-medium text-emerald-700';
          connectionHint.classList.add('hidden');
        } else {
          statusPill.textContent = 'Disconnected';
          statusPill.className = 'inline-flex items-center justify-center rounded-full border border-slate-200 bg-slate-100 px-4 py-1 text-sm font-medium text-slate-600';
          connectionHint.classList.remove('hidden');
        }

        if (status.page) {
          pageName.textContent = status.page.name || '—';
          pageId.textContent = status.page.id || '—';
        } else {
          pageName.textContent = 'Not connected';
          pageId.textContent = '—';
        }

        if (status.instagram) {
          igHandle.textContent = status.instagram.username ? `@${status.instagram.username}` : '—';
          igId.textContent = status.instagram.id || '—';
        } else {
          igHandle.textContent = 'Not linked';
          igId.textContent = '—';
        }

        if (connected) {
          connectBtn.textContent = 'Reconnect account';
        } else {
          connectBtn.textContent = 'Connect Instagram';
        }

        webhookHint.classList.toggle('hidden', connected);
        renderWebhookItems(status);
      }

      async function refreshStatus() {
        try {
          const response = await fetch('/api/status');
          if (!response.ok) {
            throw new Error('Unable to fetch status.');
          }
          const data = await response.json();
          updateConnectionSection(data);
        } catch (error) {
          console.error(error);
          showFeedback('Unable to load current status.', 'error');
        }
      }

      async function loadUserInfo() {
        try {
          const response = await fetch('/auth/status');
          if (response.ok) {
            const data = await response.json();
            if (data.authenticated && data.email) {
              const userEmail = document.getElementById('user-email');
              const userInitial = document.getElementById('user-initial');
              userEmail.textContent = data.email;
              userInitial.textContent = data.email.charAt(0).toUpperCase();
            }
          }
        } catch (error) {
          console.error('Failed to load user info:', error);
        }
      }

      const params = new URLSearchParams(window.location.search);
      if (params.get('status') === 'ok') {
        showFeedback('Instagram connected successfully.', 'success');
      }

      loadUserInfo();
      refreshStatus();

      // Webhook Dashboard Functions
      async function loadWebhookStats() {
        try {
          const response = await fetch('/api/webhook-events/stats');
          if (!response.ok) return;

          const stats = await response.json();
          document.getElementById('stat-total').textContent = stats.total || 0;
          document.getElementById('stat-pending').textContent = stats.pending || 0;
          document.getElementById('stat-processed').textContent = stats.processed || 0;
          document.getElementById('stat-failed').textContent = stats.failed || 0;
          document.getElementById('stat-dead_letter').textContent = stats.dead_letter || 0;
        } catch (error) {
          console.error('Failed to load webhook stats:', error);
        }
      }

      async function loadWebhookEvents() {
        try {
          const status = document.getElementById('statusFilter').value;
          const params = new URLSearchParams();
          if (status) params.set('status', status);
          params.set('limit', '20');

          const response = await fetch(`/api/webhook-events?${params}`);
          if (!response.ok) return;

          const data = await response.json();
          const container = document.getElementById('webhookEvents');

          if (data.events.length === 0) {
            container.innerHTML = '<p class="text-sm text-slate-500 text-center py-8">No webhook events found</p>';
            return;
          }

          container.innerHTML = data.events.map(event => {
            const statusColors = {
              pending: 'bg-blue-100 text-blue-700',
              processing: 'bg-yellow-100 text-yellow-700',
              processed: 'bg-green-100 text-green-700',
              failed: 'bg-red-100 text-red-700',
              dead_letter: 'bg-purple-100 text-purple-700'
            };

            const statusColor = statusColors[event.status] || 'bg-slate-100 text-slate-700';
            const receivedAt = new Date(event.received_at).toLocaleString();

            return `
              <div class="rounded-lg border border-slate-200 bg-white p-4 hover:border-slate-300 cursor-pointer" onclick="showEventDetails(${event.id})">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium text-slate-900">Event #${event.id}</span>
                      <span class="text-xs px-2 py-0.5 rounded-full ${statusColor}">${event.status}</span>
                      ${event.retry_count > 0 ? `<span class="text-xs text-slate-500">Retry ${event.retry_count}</span>` : ''}
                    </div>
                    <div class="mt-1 text-xs text-slate-600">
                      Type: ${event.event_type || 'unknown'} • ${receivedAt}
                    </div>
                  </div>
                  ${event.status === 'failed' || event.status === 'dead_letter' ? `
                    <button onclick="retryEvent(${event.id}, event)" class="ml-2 px-3 py-1 text-xs font-medium text-blue-600 hover:text-blue-700 border border-blue-300 rounded-lg hover:bg-blue-50">
                      Retry
                    </button>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('');
        } catch (error) {
          console.error('Failed to load webhook events:', error);
        }
      }

      async function showEventDetails(eventId) {
        try {
          const response = await fetch(`/api/webhook-events/${eventId}`);
          if (!response.ok) return;

          const event = await response.json();
          const modal = document.getElementById('eventModal');
          const details = document.getElementById('eventDetails');

          const payload = typeof event.payload === 'string' ? JSON.parse(event.payload) : event.payload;

          details.innerHTML = `
            <div class="space-y-4">
              <div>
                <div class="text-sm font-medium text-slate-700">Event ID</div>
                <div class="text-sm text-slate-900">${event.id}</div>
              </div>
              <div>
                <div class="text-sm font-medium text-slate-700">Status</div>
                <div class="text-sm text-slate-900">${event.status}</div>
              </div>
              <div>
                <div class="text-sm font-medium text-slate-700">Event Type</div>
                <div class="text-sm text-slate-900">${event.event_type || 'unknown'}</div>
              </div>
              <div>
                <div class="text-sm font-medium text-slate-700">Received At</div>
                <div class="text-sm text-slate-900">${new Date(event.received_at).toLocaleString()}</div>
              </div>
              ${event.processed_at ? `
                <div>
                  <div class="text-sm font-medium text-slate-700">Processed At</div>
                  <div class="text-sm text-slate-900">${new Date(event.processed_at).toLocaleString()}</div>
                </div>
              ` : ''}
              ${event.retry_count > 0 ? `
                <div>
                  <div class="text-sm font-medium text-slate-700">Retry Count</div>
                  <div class="text-sm text-slate-900">${event.retry_count}</div>
                </div>
              ` : ''}
              ${event.last_error ? `
                <div>
                  <div class="text-sm font-medium text-red-700">Last Error</div>
                  <div class="text-sm text-red-900 bg-red-50 p-2 rounded">${event.last_error}</div>
                </div>
              ` : ''}
              <div>
                <div class="text-sm font-medium text-slate-700 mb-2">Payload</div>
                <pre class="text-xs bg-slate-100 p-3 rounded-lg overflow-x-auto">${JSON.stringify(payload, null, 2)}</pre>
              </div>
            </div>
          `;

          modal.classList.remove('hidden');
        } catch (error) {
          console.error('Failed to load event details:', error);
        }
      }

      async function retryEvent(eventId, e) {
        e.stopPropagation();

        if (!confirm('Retry this event?')) return;

        try {
          const response = await fetch(`/api/webhook-events/${eventId}/retry`, {
            method: 'POST'
          });

          if (response.ok) {
            showFeedback('Event queued for retry', 'success');
            loadWebhookEvents();
            loadWebhookStats();
          } else {
            showFeedback('Failed to retry event', 'error');
          }
        } catch (error) {
          console.error('Failed to retry event:', error);
          showFeedback('Failed to retry event', 'error');
        }
      }

      // Event listeners
      document.getElementById('statusFilter').addEventListener('change', loadWebhookEvents);
      document.getElementById('refreshEvents').addEventListener('click', () => {
        loadWebhookEvents();
        loadWebhookStats();
      });
      document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('eventModal').classList.add('hidden');
      });
      document.getElementById('eventModal').addEventListener('click', (e) => {
        if (e.target.id === 'eventModal') {
          document.getElementById('eventModal').classList.add('hidden');
        }
      });

      // Load webhook data
      loadWebhookStats();
      loadWebhookEvents();

      // Refresh webhook data every 10 seconds
      setInterval(() => {
        loadWebhookStats();
        loadWebhookEvents();
      }, 10000);
    </script>
  </body>
</html>
